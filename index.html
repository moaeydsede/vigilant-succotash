<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b1220" />
  <meta name="description" content="Customer Evaluation โ CRM Score v2.3.0 VIP" />
  <title>Customer Evaluation โ CRM Score (VIP)</title>

  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./assets/favicon-192.png" sizes="192x192">
  <link rel="apple-touch-icon" href="./assets/icon-192.png">

  <link rel="stylesheet" href="./app.css" />

  <!-- Libraries (CDN) -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <script defer src="./app.js"></script>
</head>
<body>
  <div id="app">
    <!-- Topbar -->
    <header class="topbar">
      <button class="icon-btn" id="btnMenu" aria-label="ุงููุงุฆูุฉ">
        <span class="hamburger"></span>
      </button>
      <div class="topbar-title">
        <div class="brand-title">CRM Score</div>
        <div class="brand-sub" id="brandSub">VIP v2.3.0</div>
      </div>
      <div class="topbar-actions">
        <button class="pill-btn" id="btnRecalc" title="ุฅุนุงุฏุฉ ุงูุญุณุงุจ">ุฅุนุงุฏุฉ ุงูุญุณุงุจ</button>
        <button class="pill-btn danger" id="btnLogout" title="ุฎุฑูุฌ">ุฎุฑูุฌ</button>
      </div>
    </header>

    <!-- Sidebar / Bottom sheet -->
    <aside class="sidebar" id="sidebar" aria-hidden="true">
      <div class="sidebar-head">
        <div class="sidebar-user">
          <div class="avatar" id="sessionAvatar">A</div>
          <div>
            <div class="sidebar-name" id="sessionName">โ</div>
            <div class="sidebar-role" id="sessionRole">โ</div>
          </div>
        </div>
        <button class="icon-btn" id="btnCloseMenu" aria-label="ุฅุบูุงู">
          โ
        </button>
      </div>

      <nav class="sidebar-nav">
        <button class="nav-item" data-view="dashboard">ููุญุฉ ุงูุชุญูู</button>
        <button class="nav-item" data-view="customers">ุงูุนููุงุก</button>
        <button class="nav-item" data-view="transactions">ุงูุญุฑูุงุช</button>
        <button class="nav-item" data-view="reports">ุงูุชูุงุฑูุฑ</button>
          <button class="tab" data-view="ratios"><span>ููุณุจ</span></button>
        <button class="nav-item" data-view="excel">Excel</button>
        <button class="nav-item" data-view="pdf">PDF</button>
        <button class="nav-item" data-view="company">ุจูุงูุงุช ุงูุดุฑูุฉ</button>
        <button class="nav-item admin-only" data-view="users">ุงููุณุชุฎุฏููู</button>
      </nav>

      <div class="sidebar-foot">
        <button class="pill-btn warn" id="btnWipeLocal">ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ</button>
        <div class="muted small">* ููุถุฑูุฑุฉ ููุท โ ูุง ุฑุฌุนุฉ</div>
      </div>
    </aside>

    <div class="backdrop" id="backdrop" hidden></div>

    <!-- Main -->
    <main class="main">
      <!-- Login View -->
      <section class="view" id="view-login" data-view="login">
        <div class="login-wrap">
          <div class="login-card">
            <div class="login-head">
              <div class="login-logo">
                <img id="loginLogo" src="./assets/icon-192.png" alt="CRM" />
              </div>
              <div>
                <div class="login-title">Customer Evaluation โ CRM Score</div>
                <div class="login-sub">VIP v2.3.0 โข ุนุฑุจู 100ูช</div>
              </div>
            </div>

            <div class="login-tabs" role="tablist">
              <button class="tab active" data-login-tab="staff" role="tab" aria-selected="true">ุงูุฅุฏุงุฑุฉ / ุงููุญุงุณุจุฉ</button>
              <button class="tab" data-login-tab="viewer" role="tab" aria-selected="false">ุนุฑุถ ููุท</button>
            </div>

            <form id="loginForm" class="login-form">
              <div class="field">
                <label>ุงุณู ุงููุณุชุฎุฏู</label>
                <input id="loginUser" type="text" autocomplete="username" placeholder="admin" required />
              </div>
              <div class="field">
                <label>ูููุฉ ุงููุฑูุฑ</label>
                <input id="loginPass" type="password" autocomplete="current-password" placeholder="admin123" required />
              </div>
              <button class="btn primary" type="submit">ุฏุฎูู</button>

              <div class="hint">
                ุงูุญุณุงุจ ุงูุฑุฆูุณู: <b>admin</b> / <b>admin123</b>
              </div>
            </form>

            <form id="viewerForm" class="login-form" hidden>
              <div class="field">
                <label>ุฑูุฒ ุงูุนุฑุถ (ุงุฎุชูุงุฑู)</label>
                <input id="viewerCode" type="text" placeholder="ูุซุงู: VIEW123" />
              </div>
              <button class="btn primary" type="submit">ุฏุฎูู (ุนุฑุถ ููุท)</button>
              <div class="hint muted">
                * ุฅุฐุง ูู ูุชู ุชูุนูู ุฑูุฒ ุงูุนุฑุถ ูู ุงูุฅุนุฏุงุฏุงุช ุณูุชู ุงูุฏุฎูู ูู Viewer ุนุงู.
              </div>
            </form>

            <div class="login-foot">
              <button class="link" id="btnInstallPwa" type="button">ุชุซุจูุช ูุชุทุจูู (PWA)</button>
              <span class="dot">โข</span>
              <button class="link" id="btnSeedDemo" type="button">ุจูุงูุงุช ุชุฌุฑูุจูุฉ</button>
            </div>
          </div>
        </div>
      </section>

      <!-- Dashboard -->
      <section class="view" id="view-dashboard" data-view="dashboard" hidden>
        <div class="panel">
          <div class="panel-title">ููุญุฉ ุงูุชุญูู</div>

          <div class="kpi-grid">
            <div class="kpi">
              <div class="kpi-label">ุนุฏุฏ ุงูุนููุงุก</div>
              <div class="kpi-value" id="kpiCustomers">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ุฅุฌูุงูู ุงููุจูุนุงุช</div>
              <div class="kpi-value" id="kpiSales">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ุฅุฌูุงูู ุงูุณุฏุงุฏ</div>
              <div class="kpi-value" id="kpiPayments">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ูุณุจุฉ ุงูุณุฏุงุฏ</div>
              <div class="kpi-value" id="kpiPayRatio">0%</div>
            </div>
          </div>

          <div class="panel-sub">
            <div class="row between">
              <div class="muted">ุฃูุถู ุงูุนููุงุก</div>
              <button class="pill-btn" id="btnGoCustomers">ุนุฑุถ ุงููู</button>
            </div>
          </div>

          <div id="topCustomersList" class="cards"></div>
        </div>
      
        <div class="card">
          <div class="card-title">ุนููุงุก VIP (ููุณุจ + ูุฌูู)</div>
          <div class="muted small">ุฃูุถู 12 ุนููู ุญุณุจ ุงูุชูููู.</div>
          <div id="dashCustomers" class="list" style="margin-top:10px"></div>
        </div>
      </section>

      <!-- Customers -->
      <section class="view" id="view-customers" data-view="customers" hidden>
        <div class="panel">
          <div class="panel-title">ุงูุนููุงุก</div>

          <div class="toolbar">
            <div class="search">
              <input id="custSearch" type="search" placeholder="ุจุญุซ: ุงุณู / ูุงุชู / ูุฏููุฉ / ููุงุญุธุฉ..." />
            </div>
            <select id="custCityFilter" class="select">
              <option value="">ูู ุงููุฏู</option>
            </select>
            <select id="custStatusFilter" class="select">
              <option value="">ูู ุงูุญุงูุงุช</option>
              <option value="Active">ูุดุท</option>
              <option value="Inactive">ุบูุฑ ูุดุท</option>
            </select>
            <button class="btn primary" id="btnAddCustomer">+ ุฅุถุงูุฉ ุนููู</button>
          </div>

          <div id="customersList" class="cards"></div>
        </div>
      </section>

      <!-- Transactions -->
      <section class="view" id="view-transactions" data-view="transactions" hidden>
        <div class="panel">
          <div class="panel-title">ุงูุญุฑูุงุช</div>

          <div class="toolbar wrap">
            <div class="seg">
              <button class="seg-btn" data-add-tx="sale">+ ูุจูุนุงุช</button>
              <button class="seg-btn" data-add-tx="return">+ ูุฑุชุฌุนุงุช</button>
              <button class="seg-btn" data-add-tx="payment">+ ุณุฏุงุฏ</button>
              <button class="seg-btn" data-add-tx="discount">+ ุฎุตู</button>
            </div>

            <div class="search">
              <input id="txSearch" type="search" placeholder="ุจุญุซ: ุฑูู ูุงุชูุฑุฉ / ููุงุญุธุฉ..." />
            </div>

            <div class="date-range">
              <input id="txFrom" type="date" />
              <span class="muted">ุฅูู</span>
              <input id="txTo" type="date" />
              <button class="pill-btn" id="btnTxClearDates">ูุณุญ</button>
            </div>
          </div>

          <div id="txList" class="cards"></div>
        </div>
      </section>

      <!-- Reports -->
      <section class="view" id="view-reports" data-view="reports" hidden>
        <div class="panel">
          <div class="panel-title">ุงูุชูุงุฑูุฑ</div>

          <div class="toolbar">
            <div class="date-range">
              <input id="repFrom" type="date" />
              <span class="muted">ุฅูู</span>
              <input id="repTo" type="date" />
              <button class="pill-btn" id="btnRepApply">ุชุทุจูู</button>
              <button class="pill-btn" id="btnRepClear">ูุณุญ</button>
            </div>

            <button class="btn primary" id="btnReportPdf">ุทุจุงุนุฉ PDF</button>
            <div class="row gap" style="flex-wrap:wrap">
              <button class="btn" id="btnRepSalesReturnsPdf">ุทุจุงุนุฉ: ุงููุจูุนุงุช โ ุงููุฑุชุฌุนุงุช</button>
              <button class="btn" id="btnRepSalesPaymentsPdf">ุทุจุงุนุฉ: ุงููุจูุนุงุช โ ุงูุณุฏุงุฏ</button>
              <button class="btn" id="btnRepSalesDiscountsPdf">ุทุจุงุนุฉ: ุงููุจูุนุงุช โ ุงูุฎุตููุงุช</button>
            </div>
        
          </div>

          <div class="kpi-grid">
            <div class="kpi">
              <div class="kpi-label">ูุจูุนุงุช ุงููุชุฑุฉ</div>
              <div class="kpi-value" id="repSales">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ุณุฏุงุฏ ุงููุชุฑุฉ</div>
              <div class="kpi-value" id="repPayments">0</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ุณุฏุงุฏ%</div>
              <div class="kpi-value" id="repPayPct">0%</div>
            </div>
            <div class="kpi">
              <div class="kpi-label">ูุฑุชุฌุนุงุช%</div>
              <div class="kpi-value" id="repRetPct">0%</div>
            </div>
          </div>

          <div class="panel-sub">
            <div class="muted">ุฃูุถู ุงูุนููุงุก ุญุณุจ ุงูุชูุฑูุฑ</div>
          </div>
          <div id="repTopCustomers" class="cards"></div>
        </div>
      </section>

      
      <!-- Ratios -->
      <section class="view" id="view-ratios" hidden>
        <div class="topbar">
          <div class="topbar-title">ุตูุญุฉ ุงููููุณุจ</div>
          <div class="topbar-actions">
            <button class="icon-btn" id="btnRatiosRefresh" title="ุฅุนุงุฏุฉ ุงูุญุณุงุจ">โฒ</button>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ููุชุฑุฉ ูุทุจุงุนุฉ</div>
          <div class="card-body">
            <div class="date-range">
              <input id="ratFrom" type="date" />
              <span class="muted">ุฅูู</span>
              <input id="ratTo" type="date" />
              <button class="pill-btn" id="btnRatClear">ูุณุญ</button>
            </div>

            <div class="row gap" style="flex-wrap:wrap; margin-top:10px">
              <button class="btn primary" id="btnRatPrintReturns">ุทุจุงุนุฉ: ูุจูุนุงุช โ ูุฑุชุฌุนุงุช</button>
              <button class="btn primary" id="btnRatPrintPayments">ุทุจุงุนุฉ: ูุจูุนุงุช โ ุณุฏุงุฏ</button>
              <button class="btn primary" id="btnRatPrintDiscounts">ุทุจุงุนุฉ: ูุจูุนุงุช โ ุฎุตููุงุช</button>
            </div>

            <div class="row gap" style="flex-wrap:wrap; margin-top:10px">
              <input id="ratSearch" class="input" placeholder="ุจุญุซ ุฐูู: ุงุณู/ูุงุชู/ูุฏููุฉ" style="flex:1; min-width:180px" />
              <select id="ratSort" class="input" style="min-width:160px">
                <option value="scoreDesc">ุชุฑุชูุจ: ุงูุฃุนูู Score</option>
                <option value="paymentsDesc">ุชุฑุชูุจ: ุงูุฃุนูู ุณุฏุงุฏ%</option>
                <option value="returnsAsc">ุชุฑุชูุจ: ุงูุฃูู ูุฑุชุฌุนุงุช%</option>
              </select>
            </div>

            <div class="muted small" style="margin-top:8px">
              ููุงุญุธุฉ: ุงููููุณุจ ูุญุณูุจุฉ = (ุณุฏุงุฏ/ูุจูุนุงุช) ู (ูุฑุชุฌุนุงุช/ูุจูุนุงุช). ูููู ุงูุทุจุงุนุฉ ุญุณุจ ุงููุชุฑุฉ ุงููุญุฏุฏุฉ.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-title">ูุฑูุช ุงูุนููุงุก (ููุณุจ + ูุฌูู + Score)</div>
          <div class="muted small">ุงุถุบุท "ููุณุจ" ุฏุงุฎู ุงูุนููู ูุทุจุงุนุฉ ุชูุงุฑูุฑ ุงูุนููู ูุญุฏู.</div>
          <div id="ratList" class="list" style="margin-top:10px"></div>
        </div>
      </section>
    
<!-- Excel -->
      <section class="view" id="view-excel" data-view="excel" hidden>
        <div class="panel">
          <div class="panel-title">Excel</div>

          <div class="grid2">
            <div class="card">
              <div class="card-title">ุชุญููู ุงูููุงูุจ</div>
              <div class="card-body">
                <button class="btn" id="btnDownloadTemplate">ุชุญููู ูุงูุจ (ูุงูู)</button>
                <button class="btn" id="btnDownloadCustomersTemplate">ุชุญููู ูุงูุจ (ุนููุงุก ููุท)</button>
                <div class="muted small">ุงููุงูุจ ูููุดุฃ ุชููุงุฆููุง ุจููุณ ุงูุฃุนูุฏุฉ ุงููุทููุจุฉ.</div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">ุชุตุฏูุฑ</div>
              <div class="card-body">
                <button class="btn primary" id="btnExportAll">ุชุตุฏูุฑ ุงูุจูุงูุงุช ูุงููุฉ</button>
                <button class="btn" id="btnExportCustomersOnly">ุชุตุฏูุฑ ุงูุนููุงุก ููุท</button>
              </div>
            </div>

            <div class="card">
              <div class="card-title">ุงุณุชูุฑุงุฏ</div>
              <div class="card-body">
                <input type="file" id="fileImportAll" accept=".xlsx,.xls" hidden />
                <input type="file" id="fileImportCustomers" accept=".xlsx,.xls" hidden />
                <button class="btn warn" id="btnImportAll">ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช (ูุงูู)</button>
                <button class="btn warn" id="btnImportCustomersOnly">ุงุณุชูุฑุงุฏ ุงูุนููุงุก ููุท</button>
                <div class="muted small">* ุงูุงุณุชูุฑุงุฏ ูุณุชุจุฏู ุงูุจูุงูุงุช ุฏุงุฎู ุงูุฌูุงุฒ.</div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">ุณุฌู ุงูุนูููุงุช</div>
              <div class="card-body">
                <div id="opsLog" class="log"></div>
                <button class="pill-btn" id="btnClearLog">ูุณุญ ุงูุณุฌู</button>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PDF -->
      <section class="view" id="view-pdf" data-view="pdf" hidden>
        <div class="panel">
          <div class="panel-title">PDF (A4)</div>

          <div class="grid2">
            <div class="card">
              <div class="card-title">ุฃูุถู ุงูุนููุงุก</div>
              <div class="card-body">
                <button class="btn primary" id="btnPdfTop">ุทุจุงุนุฉ ุฃูุถู ุงูุนููุงุก</button>
                <div class="muted small">ูุนุชูุฏ ุนูู ุขุฎุฑ ุฅุนุงุฏุฉ ุญุณุงุจ.</div>
              </div>
            </div>

            <div class="card">
              <div class="card-title">ูุดู ุญุณุงุจ ุนููู</div>
              <div class="card-body">
                <div class="field">
                  <label>ุงุฎุชูุงุฑ ุนููู</label>
                  <select id="stmtCustomer" class="select"></select>
                </div>
                <div class="date-range">
                  <input id="stmtFrom" type="date" />
                  <span class="muted">ุฅูู</span>
                  <input id="stmtTo" type="date" />
                </div>
                <button class="btn primary" id="btnPdfStatement">ุทุจุงุนุฉ ูุดู ุงูุญุณุงุจ</button>
              </div>
            </div>
            <div class="card">
              <div class="card-title">ุชูุงุฑูุฑ ุงูููุณุจ (ูู ุชูุฑูุฑ ููุญุฏู)</div>
              <div class="card-body">
                <div class="date-range">
                  <input id="pdfRepFrom" type="date" />
                  <span class="muted">ุฅูู</span>
                  <input id="pdfRepTo" type="date" />
                  <button class="pill-btn" id="btnPdfRepClear">ูุณุญ</button>
                </div>
                <button class="btn primary" id="btnPdfSalesReturns">ุชูุฑูุฑ: ุงููุจูุนุงุช โ ุงููุฑุชุฌุนุงุช</button>
                <button class="btn primary" id="btnPdfSalesPayments">ุชูุฑูุฑ: ุงููุจูุนุงุช โ ุงูุณุฏุงุฏ</button>
                <button class="btn primary" id="btnPdfSalesDiscounts">ุชูุฑูุฑ: ุงููุจูุนุงุช โ ุงูุฎุตููุงุช</button>
                <div class="muted small">ูุชุถูู (ุงูููุณุจ + ุงูุชูููู ุจุงููุฌูู) ููู ุนููู.</div>
              </div>
            </div>

          </div>
        </div>
      </section>

      <!-- Company -->
      <section class="view" id="view-company" data-view="company" hidden>
        <div class="panel">
          <div class="panel-title">ุจูุงูุงุช ุงูุดุฑูุฉ</div>

          <div class="form-grid">
            <div class="field">
              <label>ุงุณู ุงูุดุฑูุฉ</label>
              <input id="coName" type="text" placeholder="ุงุณู ุงูุดุฑูุฉ" />
            </div>
            <div class="field">
              <label>ุงููุงุชู</label>
              <input id="coPhone" type="text" placeholder="0100..." />
            </div>
            <div class="field">
              <label>ุงููุฏููุฉ</label>
              <input id="coCity" type="text" placeholder="ุงููุงูุฑุฉ" />
            </div>
            <div class="field">
              <label>ุฑุงุจุท ุงูุดุนุงุฑ (URL)</label>
              <input id="coLogoUrl" type="url" placeholder="https://..." />
            </div>

            <div class="card soft">
              <div class="card-title">Viewer Code (ุงุฎุชูุงุฑู)</div>
              <div class="card-body">
                <div class="field">
                  <label>ุฑูุฒ ุฏุฎูู ุงูุนุฑุถ ููุท</label>
                  <input id="viewerCodeSetting" type="text" placeholder="ูุซุงู: VIEW123" />
                </div>
                <div class="muted small">ุฅุฐุง ูุงู ูุงุฑุบูุง: ุงูุฏุฎูู ูู Viewer ุนุงู.</div>
              </div>
            </div>

            <div class="card soft">
              <div class="card-title">Firebase (ุงุฎุชูุงุฑู)</div>
              <div class="card-body">
                <div class="muted small">ูุฐู ุงูุฅุนุฏุงุฏุงุช ูุญููุธุฉ ููุท โ ุงููุฒุงููุฉ ููุณุช ููุนูุฉ ุงูุชุฑุงุถููุง (ุจุฏูู ุณูุฑูุฑ).</div>
                <textarea id="fbConfig" rows="6" placeholder='{"apiKey":"...","projectId":"..."}'></textarea>
              </div>
            </div>

            <div class="row gap">
              <button class="btn primary" id="btnSaveCompany">ุญูุธ</button>
              <button class="btn" id="btnPreviewLogo">ูุนุงููุฉ ุงูุดุนุงุฑ</button>
            </div>

            <div class="logo-preview" id="logoPreview" hidden>
              <img id="logoPreviewImg" alt="logo" />
            </div>
          </div>
        </div>
      </section>

      <!-- Users (Admin only) -->
      <section class="view" id="view-users" data-view="users" hidden>
        <div class="panel">
          <div class="panel-title">ุงููุณุชุฎุฏููู (Admin ููุท)</div>

          <div class="toolbar">
            <button class="btn primary" id="btnAddUser">+ ุฅุถุงูุฉ ูุณุชุฎุฏู</button>
          </div>

          <div id="usersList" class="cards"></div>
        </div>
      </section>
    </main>

    <!-- Bottom Tab Bar -->
    <footer class="tabbar" id="tabbar" hidden>
      <button class="tabbtn" data-view="dashboard">
        <span class="ico">๐</span><span class="lbl">ุงูุฑุฆูุณูุฉ</span>
      </button>
      <button class="tabbtn" data-view="customers">
        <span class="ico">๐ฅ</span><span class="lbl">ุงูุนููุงุก</span>
      </button>
      <button class="tabbtn" data-view="transactions">
        <span class="ico">๐งพ</span><span class="lbl">ุงูุญุฑูุงุช</span>
      </button>
      <button class="tabbtn" data-view="reports">
        <span class="ico">๐</span><span class="lbl">ุงูุชูุงุฑูุฑ</span>
      </button>
      <button class="tabbtn" data-view="excel">
        <span class="ico">๐ฅ</span><span class="lbl">Excel</span>
      </button>
    </footer>

    <!-- Modal -->
    <div class="modal" id="modal" hidden>
      <div class="modal-card">
        <div class="modal-head">
          <div class="modal-title" id="modalTitle">โ</div>
          <button class="icon-btn" id="modalClose" aria-label="ุฅุบูุงู">โ</button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-foot" id="modalFoot"></div>
      </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast" hidden></div>
  </div>
</body>
</html>
