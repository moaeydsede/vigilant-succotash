<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Evaluation โ CRM Score</title>
  <meta name="theme-color" content="#1d4ed8" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="app.css" />
  <!-- SheetJS -->
  <script defer src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js"></script>
  <!-- jsPDF + autoTable -->
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.31/dist/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase (compat for easy vanilla use) -->
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-app-compat.js"></script>
  <script defer src="https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore-compat.js"></script>

  <script defer src="app.js"></script>
</head>
<body>
  <div id="toastHost" class="toast-host" aria-live="polite" aria-atomic="true"></div>

  <!-- Login -->
  <section id="loginView" class="view">
    <div class="login-wrap">
      <div class="brand">
        <div class="logo">CRM</div>
        <div class="brand-txt">
          <h1>ุชูููู ุงูุนููุงุก</h1>
          <p>Customer Evaluation โ CRM Score</p>
        </div>
      </div>

      <div class="card login-card">
        <div class="card-h">
          <h2>ุชุณุฌูู ุงูุฏุฎูู</h2>
          <span class="pill">Frontend Only</span>
        </div>

        <div class="grid2">
          <label class="field">
            <span>ุงุณู ุงููุณุชุฎุฏู</span>
            <input id="loginUser" type="text" autocomplete="username" placeholder="ูุซุงู: admin" />
          </label>
          <label class="field">
            <span>ูููุฉ ุงููุฑูุฑ</span>
            <input id="loginPass" type="password" autocomplete="current-password" placeholder="โขโขโขโขโขโขโขโข" />
          </label>
        </div>

        <div class="actions">
          <button id="btnLogin" class="btn primary">ุฏุฎูู</button>
          <button id="btnResetDemo" class="btn ghost" title="ุฅุนุงุฏุฉ ุถุจุท ุจูุงูุงุช ุชุฌุฑูุจูุฉ ูุญููุฉ">ุชููุฆุฉ ุณุฑูุนุฉ (Demo)</button>
        </div>

        <div class="muted small">
          ุงูุญุณุงุจ ุงูุงูุชุฑุงุถู: <b>admin / admin123</b> โ ุงูุฏูุฑ: <b>Admin</b>
        </div>
      </div>

      <div class="footnote">
        ูุนูู ุจุฏูู ุณูุฑูุฑ. ุงูุจูุงูุงุช ูุญูููุง (LocalStorage) + ุงุฎุชูุงุฑููุง Firestore.
      </div>
    </div>
  </section>

  <!-- App -->
  <section id="appView" class="view hidden">
    <header class="topbar">
      <button id="btnMenu" class="icon-btn" aria-label="ุงููุงุฆูุฉ">
        <span class="hamburger"></span>
      </button>
      <div class="top-title">
        <div class="ttl">Customer Evaluation โ CRM Score</div>
        <div class="subttl" id="companySubtitle">โ</div>
      </div>
      <div class="top-actions">
        <button id="btnSync" class="btn soft" title="ูุฒุงููุฉ (ูุฑุงุกุฉ/ูุชุงุจุฉ) ูุน Firestore">ูุฒุงููุฉ</button>
        <button id="btnLogout" class="btn danger">ุฎุฑูุฌ</button>
      </div>
    </header>

    <aside id="sidebar" class="sidebar hidden" aria-hidden="true">
      <div class="side-head">
        <div class="side-user">
          <div class="avatar" id="avatar">A</div>
          <div>
            <div class="who" id="whoName">โ</div>
            <div class="role" id="whoRole">โ</div>
          </div>
        </div>
        <button id="btnCloseMenu" class="icon-btn" aria-label="ุฅุบูุงู">โ</button>
      </div>

      <nav class="nav">
        <button class="nav-item active" data-route="dashboard">๐ ููุญุฉ ุงูุชุญูู</button>
        <button class="nav-item" data-route="customers">๐ฅ ุงูุนููุงุก</button>
        <button class="nav-item" data-route="transactions">๐ ุงูุญุฑูุงุช</button>
        <button class="nav-item" data-route="invoices">๐งพ ุงูููุงุชูุฑ</button>
        <button class="nav-item" data-route="excel">๐ค Excel</button>
        <button class="nav-item" data-route="pdf">๐จ๏ธ PDF</button>
        <button class="nav-item" data-route="company">๐ข ุจูุงูุงุช ุงูุดุฑูุฉ</button>
        <button class="nav-item" data-route="users">๐ค ุงููุณุชุฎุฏููู</button>
        <div class="nav-sep"></div>
        <button class="nav-item danger" id="btnWipeLocal">๐งน ูุณุญ ุงูุจูุงูุงุช ุงููุญููุฉ</button>
      </nav>

      <div class="side-foot muted small">
        <div>ูุณุฎุฉ: <span id="appVersion">v1.0</span></div>
        <div>Storage: LocalStorage + Firestore (ุงุฎุชูุงุฑู)</div>
      </div>
    </aside>

    <main class="main">
      <!-- DASHBOARD -->
      <section class="page" id="page-dashboard">
        <div class="page-head">
          <h2>ููุญุฉ ุงูุชุญูู</h2>
          <div class="head-actions">
            <button class="btn soft" id="btnRecalcAll">ุฅุนุงุฏุฉ ุญุณุงุจ ุงูุชูููู</button>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi card">
            <div class="kpi-label">ุนุฏุฏ ุงูุนููุงุก</div>
            <div class="kpi-val" id="kpiCustomers">0</div>
          </div>
          <div class="kpi card">
            <div class="kpi-label">ูุชูุณุท ุงูุชูููู</div>
            <div class="kpi-val" id="kpiAvg">0%</div>
          </div>
          <div class="kpi card">
            <div class="kpi-label">ุนููุงุก VIP</div>
            <div class="kpi-val" id="kpiVip">0</div>
          </div>
          <div class="kpi card">
            <div class="kpi-label">ุนููุงุก ุฎุทุฑ</div>
            <div class="kpi-val" id="kpiRisk">0</div>
          </div>
        </div>

        <div class="grid2 gap">
          <div class="card">
            <div class="card-h">
              <h3>ุฃูุถู ุงูุนููุงุก</h3>
              <span class="pill">Top 10</span>
            </div>
            <div class="list" id="topCustomers"></div>
          </div>
          <div class="card">
            <div class="card-h">
              <h3>ุฅุญุตุงุก ุณุฑูุน</h3>
              <span class="pill">Score Engine</span>
            </div>
            <div class="muted small">
              ุงูุฃูุฒุงู: Sales +0.4 โ Returns โ0.3 โ Payments +0.2 โ Discounts โ0.1
            </div>
            <div class="mini">
              <div class="mini-row"><span>VIP (90โ100)</span><span class="badge vip">VIP</span></div>
              <div class="mini-row"><span>ุฌูุฏ ุฌุฏูุง (75โ89)</span><span class="badge good">ุฌูุฏ</span></div>
              <div class="mini-row"><span>ูุชูุณุท (60โ74)</span><span class="badge mid">ูุชูุณุท</span></div>
              <div class="mini-row"><span>ุถุนูู (40โ59)</span><span class="badge warn">ุชูุจูู</span></div>
              <div class="mini-row"><span>ุฎุทุฑ (0โ39)</span><span class="badge danger">ุฎุทุฑ</span></div>
            </div>
          </div>
        </div>
      </section>

      <!-- CUSTOMERS -->
      <section class="page hidden" id="page-customers">
        <div class="page-head">
          <h2>ุงูุนููุงุก</h2>
          <div class="head-actions">
            <button class="btn primary" id="btnAddCustomer">+ ุฅุถุงูุฉ ุนููู</button>
          </div>
        </div>

        <div class="filters card">
          <div class="grid3">
            <label class="field">
              <span>ุจุญุซ</span>
              <input id="custSearch" type="search" placeholder="ุงุจุญุซ ุจุงูุงุณู / ุงููุงุชู / ุงููุฏููุฉ..." />
            </label>
            <label class="field">
              <span>ุงููุฏููุฉ</span>
              <select id="custCityFilter"></select>
            </label>
            <label class="field">
              <span>ุงูุญุงูุฉ</span>
              <select id="custStatusFilter">
                <option value="">ุงููู</option>
                <option value="Active">ูุดุท</option>
                <option value="Inactive">ุบูุฑ ูุดุท</option>
              </select>
            </label>
          </div>
          <div class="grid3">
            <label class="field">
              <span>ุงููุฌูู</span>
              <select id="custStarsFilter">
                <option value="">ุงููู</option>
                <option value="5">โญโญโญโญโญ</option>
                <option value="4">โญโญโญโญ</option>
                <option value="3">โญโญโญ</option>
                <option value="2">โญโญ</option>
                <option value="1">โญ</option>
              </select>
            </label>
            <label class="field">
              <span>ุชุฑุชูุจ ุญุณุจ</span>
              <select id="custSort">
                <option value="score_desc">ุงูุฃุนูู ุชูููููุง</option>
                <option value="score_asc">ุงูุฃูู ุชูููููุง</option>
                <option value="name_asc">ุงูุงุณู (ุฃ-ู)</option>
                <option value="name_desc">ุงูุงุณู (ู-ุฃ)</option>
                <option value="created_desc">ุงูุฃุญุฏุซ</option>
                <option value="created_asc">ุงูุฃูุฏู</option>
              </select>
            </label>
            <div class="field">
              <span>ูุชุงุฆุฌ</span>
              <div class="chip" id="custCount">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ูุงุฆูุฉ ุงูุนููุงุก</h3>
            <span class="pill">Cards</span>
          </div>
          <div class="list" id="customersList"></div>
        </div>
      </section>

      <!-- TRANSACTIONS -->
      <section class="page hidden" id="page-transactions">
        <div class="page-head">
          <h2>ุงูุญุฑูุงุช</h2>
          <div class="head-actions">
            <button class="btn soft" id="btnAddSale">+ ูุจูุนุงุช</button>
            <button class="btn soft" id="btnAddReturn">+ ูุฑุชุฌุนุงุช</button>
            <button class="btn soft" id="btnAddPayment">+ ุณุฏุงุฏ</button>
            <button class="btn soft" id="btnAddDiscount">+ ุฎุตู</button>
          </div>
        </div>

        <div class="filters card">
          <div class="grid3">
            <label class="field">
              <span>ุงูุนููู</span>
              <select id="txCustomer"></select>
            </label>
            <label class="field">
              <span>ุงูููุน</span>
              <select id="txType">
                <option value="">ุงููู</option>
                <option value="sales">ูุจูุนุงุช</option>
                <option value="returns">ูุฑุชุฌุนุงุช</option>
                <option value="payments">ุณุฏุงุฏ</option>
                <option value="discounts">ุฎุตููุงุช</option>
              </select>
            </label>
            <label class="field">
              <span>ุจุญุซ (ูุงุชูุฑุฉ/ููุงุญุธุฉ)</span>
              <input id="txSearch" type="search" placeholder="invoiceNo / note..." />
            </label>
          </div>
          <div class="grid3">
            <label class="field">
              <span>ูู ุชุงุฑูุฎ</span>
              <input id="txFrom" type="date" />
            </label>
            <label class="field">
              <span>ุฅูู ุชุงุฑูุฎ</span>
              <input id="txTo" type="date" />
            </label>
            <div class="field">
              <span>ุงููุฌููุน</span>
              <div class="chip" id="txTotal">0</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ูุงุฆูุฉ ุงูุญุฑูุงุช</h3>
            <span class="pill">Filter</span>
          </div>
          <div class="list" id="txList"></div>
        </div>
      </section>

      <!-- INVOICES -->
      <section class="page hidden" id="page-invoices">
        <div class="page-head">
          <h2>ุงูููุงุชูุฑ</h2>
          <div class="head-actions">
            <button class="btn soft" id="btnRefreshInvoices">ุชุญุฏูุซ</button>
          </div>
        </div>

        <div class="filters card">
          <div class="grid3">
            <label class="field">
              <span>ุงูุนููู</span>
              <select id="invCustomer"></select>
            </label>
            <label class="field">
              <span>ุจุญุซ ุฑูู ูุงุชูุฑุฉ</span>
              <input id="invSearch" type="search" placeholder="ูุซุงู: INV-1001" />
            </label>
            <label class="field">
              <span>ุชุฑุชูุจ</span>
              <select id="invSort">
                <option value="date_desc">ุงูุฃุญุฏุซ</option>
                <option value="date_asc">ุงูุฃูุฏู</option>
                <option value="score_desc">ุฃุนูู Score</option>
                <option value="score_asc">ุฃูู Score</option>
              </select>
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ุชุฌููุน ุญุณุจ invoiceNo</h3>
            <span class="pill">Sales/Returns/Payments/Discounts</span>
          </div>
          <div class="list" id="invList"></div>
        </div>
      </section>

      <!-- EXCEL -->
      <section class="page hidden" id="page-excel">
        <div class="page-head">
          <h2>Excel</h2>
          <div class="head-actions">
            <button class="btn soft" id="btnDownloadTemplate">ุชุญููู ูุงูุจ</button>
            <button class="btn soft" id="btnExportExcel">ุชุตุฏูุฑ</button>
            <label class="btn primary file-btn">
              ุงุณุชูุฑุงุฏ
              <input id="fileExcel" type="file" accept=".xlsx,.xls" hidden />
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ููุงุญุธุงุช ูููุฉ</h3>
            <span class="pill">SheetJS</span>
          </div>
          <ul class="bullets">
            <li>ุงูุงุณุชูุฑุงุฏ ูุฏุนู ุฏูุนุฉ ูุงุญุฏุฉ ููู ุงูุดูุชุงุช: customers, sales, returns, payments, discounts.</li>
            <li>ุงูุชูุงุฑูุฎ ูููู ุฃู ุชููู Date ุฃู ูุต ุจุตูุบุฉ YYYY-MM-DD.</li>
            <li>ุจุนุฏ ุงูุงุณุชูุฑุงุฏ ูุชู ุฅุนุงุฏุฉ ุญุณุงุจ ุชูููู ุงูุนููุงุก ุชููุงุฆููุง.</li>
          </ul>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ูุนุงููุฉ ุขุฎุฑ ุนูููุฉ</h3>
            <span class="pill">Log</span>
          </div>
          <pre id="excelLog" class="pre"></pre>
        </div>
      </section>

      <!-- PDF -->
      <section class="page hidden" id="page-pdf">
        <div class="page-head">
          <h2>PDF</h2>
          <div class="head-actions">
            <button class="btn soft" id="btnPdfTop">ุฃูุถู ุงูุนููุงุก (Top 20)</button>
            <button class="btn primary" id="btnPdfStatement">ูุดู ุญุณุงุจ ุนููู</button>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ุฅุนุฏุงุฏ ูุดู ุงูุญุณุงุจ</h3>
            <span class="pill">A4 ุงุญุชุฑุงูู</span>
          </div>
          <div class="grid2">
            <label class="field">
              <span>ุงุฎุชูุงุฑ ุนููู</span>
              <select id="pdfCustomer"></select>
            </label>
            <label class="field">
              <span>ูุฏุฉ (ุงุฎุชูุงุฑู)</span>
              <select id="pdfRange">
                <option value="">ูู ุงููุชุฑุฉ</option>
                <option value="30">ุขุฎุฑ 30 ููู</option>
                <option value="90">ุขุฎุฑ 90 ููู</option>
                <option value="180">ุขุฎุฑ 180 ููู</option>
                <option value="365">ุขุฎุฑ 365 ููู</option>
              </select>
            </label>
          </div>
          <div class="muted small">
            ุณูุชู ุชุถููู: ูุจูุนุงุช / ูุฑุชุฌุนุงุช / ุณุฏุงุฏ / ุฎุตููุงุช + ุฅุฌูุงูู ููุณุจุฉ ุงูุชูููู ูุงููุฌูู.
          </div>
        </div>
      </section>

      <!-- COMPANY -->
      <section class="page hidden" id="page-company">
        <div class="page-head">
          <h2>ุจูุงูุงุช ุงูุดุฑูุฉ</h2>
          <div class="head-actions">
            <button class="btn primary" id="btnSaveCompany">ุญูุธ</button>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ูุนูููุงุช</h3>
            <span class="pill">LocalStorage</span>
          </div>
          <div class="grid2">
            <label class="field">
              <span>ุงุณู ุงูุดุฑูุฉ</span>
              <input id="coName" type="text" placeholder="ูุซุงู: ุดุฑูุฉ ุงููุฌุงุญ" />
            </label>
            <label class="field">
              <span>ูุงุชู</span>
              <input id="coPhone" type="tel" placeholder="01xxxxxxxxx" />
            </label>
            <label class="field">
              <span>ุงููุฏููุฉ</span>
              <input id="coCity" type="text" placeholder="ุงููุงูุฑุฉ" />
            </label>
            <label class="field">
              <span>ุดุนุงุฑ (ุงุฎุชูุงุฑู)</span>
              <input id="coLogo" type="text" placeholder="ุถุน ุฑุงุจุท ุดุนุงุฑ (URL) ุฅู ุฑุบุจุช" />
            </label>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>Firebase Config</h3>
            <span class="pill">Firestore</span>
          </div>
          <div class="muted small">
            ุฃุฏุฎู ุฅุนุฏุงุฏุงุช ูุดุฑูุน Firebase ุงูุฎุงุต ุจู (Spark ูุฌุงูู). ุจุฏูููุง ุณูุนูู ุงููุธุงู ูุญูููุง ููุท.
          </div>
          <div class="grid2">
            <label class="field"><span>apiKey</span><input id="fb_apiKey" type="text" /></label>
            <label class="field"><span>authDomain</span><input id="fb_authDomain" type="text" /></label>
            <label class="field"><span>projectId</span><input id="fb_projectId" type="text" /></label>
            <label class="field"><span>storageBucket</span><input id="fb_storageBucket" type="text" /></label>
            <label class="field"><span>messagingSenderId</span><input id="fb_messagingSenderId" type="text" /></label>
            <label class="field"><span>appId</span><input id="fb_appId" type="text" /></label>
          </div>
          <div class="actions">
            <button class="btn soft" id="btnTestFirebase">ุงุฎุชุจุงุฑ ุงูุงุชุตุงู</button>
          </div>
          <div id="fbStatus" class="muted small"></div>
        </div>
      </section>

      <!-- USERS -->
      <section class="page hidden" id="page-users">
        <div class="page-head">
          <h2>ุงููุณุชุฎุฏููู</h2>
          <div class="head-actions">
            <button class="btn primary" id="btnAddUser">+ ุฅุถุงูุฉ ูุณุชุฎุฏู</button>
          </div>
        </div>

        <div class="card">
          <div class="card-h">
            <h3>ุฅุฏุงุฑุฉ ุงููุณุชุฎุฏููู</h3>
            <span class="pill">Local</span>
          </div>
          <div class="muted small">
            <b>ุชูุจูู:</b> ูุฐู ุฅุฏุงุฑุฉ ูุณุชุฎุฏููู ูุญููุฉ ููุงุณุชุฎุฏุงู ุงูุฏุงุฎูู. ููุงุณุชุฎุฏุงู ูุชุนุฏุฏ ุงููุณุชุฎุฏููู ุจุดูู ุงุญุชุฑุงูู ุงุณุชุฎุฏู Firebase Authentication + Security Rules.
          </div>
          <div class="list" id="usersList"></div>
        </div>
      </section>
    </main>

    <!-- MODAL -->
    <div id="modalHost" class="modal-host hidden" role="dialog" aria-modal="true" aria-hidden="true">
      <div class="modal-backdrop" id="modalBackdrop"></div>
      <div class="modal" role="document">
        <div class="modal-h">
          <h3 id="modalTitle">โ</h3>
          <button class="icon-btn" id="modalClose" aria-label="ุฅุบูุงู">โ</button>
        </div>
        <div class="modal-b" id="modalBody"></div>
        <div class="modal-f" id="modalFooter"></div>
      </div>
    </div>
  </section>
</body>
</html>
